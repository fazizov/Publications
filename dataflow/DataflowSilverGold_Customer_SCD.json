{
	"name": "DataflowSilverGold_Customer_SCD",
	"properties": {
		"folder": {
			"name": "Child flows/Gold"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "SilverCustomer"
				},
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "GoldDimWatermarks"
				},
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "GoldDimCustomer"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "GoldDimCustomerTarget1"
				},
				{
					"name": "LastKeyCache"
				},
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "TargetWatermark"
				},
				{
					"linkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					},
					"name": "GoldDimCustomerTarget2"
				}
			],
			"transformations": [
				{
					"name": "SelectSourceTarget"
				},
				{
					"name": "Filter1"
				},
				{
					"name": "SurrogateKey1"
				},
				{
					"name": "CalculateKey"
				},
				{
					"name": "AddTableName"
				},
				{
					"name": "CalculateMaxKey"
				},
				{
					"name": "AlterRow"
				},
				{
					"name": "CalculateSignature"
				},
				{
					"name": "GetTargetRows"
				},
				{
					"name": "LookupTargetRows"
				},
				{
					"name": "FilterInactiveRows"
				},
				{
					"name": "SelectInactiveCols"
				},
				{
					"name": "UpdateSCDInactive"
				},
				{
					"name": "FilterActive"
				},
				{
					"name": "UpdateSCDActive"
				},
				{
					"name": "AlterRowInactive"
				},
				{
					"name": "Select1"
				}
			],
			"script": "source(output(\n\t\tCompanyName as string,\n\t\tCustomerID as string,\n\t\tEmailAddress as string,\n\t\tFirstName as string,\n\t\tLastName as string,\n\t\tMiddleName as string,\n\t\tModifiedDate as string,\n\t\tNameStyle as string,\n\t\tPasswordHash as string,\n\t\tPasswordSalt as string,\n\t\tPhone as string,\n\t\tSalesPerson as string,\n\t\tSuffix as string,\n\t\tTitle as string,\n\t\trowguid as string,\n\t\tSourceFileName as string,\n\t\tDateInserted as timestamp,\n\t\tCompanyName_Prev as string,\n\t\tUserName as string,\n\t\tDomain as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/silver/Customer') ~> SilverCustomer\nsource(output(\n\t\tTableName as string,\n\t\tLastKey as long\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/gold/dimWatermarks') ~> GoldDimWatermarks\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/gold/DimCustomer') ~> GoldDimCustomer\nLookupTargetRows select(mapColumn(\n\t\tProductID = SilverCustomer@ProductID,\n\t\tName = SilverCustomer@Name,\n\t\tProductNumber = SilverCustomer@ProductNumber,\n\t\tColor = SilverCustomer@Color,\n\t\tStandardCost = SilverCustomer@StandardCost,\n\t\tListPrice = SilverCustomer@ListPrice,\n\t\tSize = SilverCustomer@Size,\n\t\tWeight = SilverCustomer@Weight,\n\t\tModifiedDate,\n\t\tDateInserted,\n\t\tProductCategory = SilverCategory@Name,\n\t\tProductModel = SilverModel@Name,\n\t\tRowSignature,\n\t\tTargetRowSignature = GoldDimCustomer@RowSignature,\n\t\tEffectiveFromDate,\n\t\tEffectiveToDate,\n\t\tIsActive,\n\t\tTargetProductKey = ProductKey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSourceTarget\nGoldDimWatermarks filter(TableName==\"DimProduct\") ~> Filter1\nUpdateSCDActive keyGenerate(output(ProductKey as long),\n\tstartAt: 1L) ~> SurrogateKey1\nSurrogateKey1 derive(ProductKey = ProductKey+ toInteger(LastKeyCache#outputs()[1].LastKey)) ~> CalculateKey\nCalculateKey derive(TableName = \"DimProduct\") ~> AddTableName\nAddTableName aggregate(groupBy(TableName),\n\tLastKey = max(ProductKey)) ~> CalculateMaxKey\nCalculateMaxKey alterRow(updateIf(TableName==\"DimProduct\")) ~> AlterRow\nSilverCustomer derive(RowSignature = crc32(256,SilverProduct@Name,ProductNumber,Color,StandardCost,ListPrice,Size,Weight,SilverCategory@Name,SilverModel@Name)) ~> CalculateSignature\nGoldDimCustomer filter(IsActive==1) ~> GetTargetRows\nCalculateSignature, GetTargetRows lookup(SilverProduct@ProductID == GoldDimCustomer@ProductID,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupTargetRows\nSelectSourceTarget filter(TargetRowSignature!=RowSignature) ~> FilterInactiveRows\nUpdateSCDInactive select(mapColumn(\n\t\tProductID,\n\t\tEffectiveToDate,\n\t\tIsActive,\n\t\tProductKey = TargetProductKey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectInactiveCols\nFilterInactiveRows derive(EffectiveToDate = currentTimestamp(),\n\t\tIsActive = 0) ~> UpdateSCDInactive\nSelectSourceTarget filter(isNull(TargetRowSignature) || TargetRowSignature!=RowSignature) ~> FilterActive\nSelect1 derive(EffectiveFromDate = currentTimestamp(),\n\t\tEffectiveToDate = toTimestamp('9099-01-01', 'yyyy-MM-dd'),\n\t\tIsActive = 1) ~> UpdateSCDActive\nSelectInactiveCols alterRow(updateIf(!isNull(ProductID))) ~> AlterRowInactive\nFilterActive select(mapColumn(\n\t\tProductID,\n\t\tName,\n\t\tProductNumber,\n\t\tColor,\n\t\tStandardCost,\n\t\tListPrice,\n\t\tSize,\n\t\tWeight,\n\t\tModifiedDate,\n\t\tDateInserted,\n\t\tProductCategory,\n\t\tProductModel,\n\t\tRowSignature,\n\t\tEffectiveFromDate,\n\t\tEffectiveToDate,\n\t\tIsActive\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nCalculateKey sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/gold/DimCustomer',\n\tmergeSchema: false,\n\tautoCompact: false,\n\toptimizedWrite: false,\n\tvacuum: 0,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> GoldDimCustomerTarget1\nFilter1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tstore: 'cache',\n\tformat: 'inline',\n\toutput: false,\n\tsaveOrder: 1) ~> LastKeyCache\nAlterRow sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/gold/dimWatermarks',\n\tmergeSchema: false,\n\tautoCompact: false,\n\toptimizedWrite: false,\n\tvacuum: 0,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:true,\n\tkeys:['TableName'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> TargetWatermark\nAlterRowInactive sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delta',\n\tcontainer: 'syn-fs',\n\tfolderPath: 'delta/gold/DimCustomer',\n\tmergeSchema: false,\n\tautoCompact: false,\n\toptimizedWrite: false,\n\tvacuum: 0,\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['ProductKey'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> GoldDimCustomerTarget2"
		}
	}
}